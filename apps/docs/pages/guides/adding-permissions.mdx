import Layout from '~/layouts/DefaultGuideLayout'
import StepHikeCompact from '~/components/StepHikeCompact'
import Link from 'next/link'
import { GlassPanel, IconPanel, Button, IconChevronRight } from 'ui'
import RefDetailCollapse from '~/components/reference/RefDetailCollapse'

export const meta = {
  id: 'adding-permissions',
  title: 'Adding Permissions',
  description: 'Add access permissions to your first API.',
  subtitle: 'Add Authentication and Authorization for user specific permissions.',
  breadcrumb: 'Guides'
}

<StepHikeCompact>

  <StepHikeCompact.Step step={1}>
    <StepHikeCompact.Details title="Enable authentication services">

      Uncomment the following paths in the `docker-compose.yml` file.
      - The auth/jwt relevant environment variables in the `app` and `hasura` services
      - The entirety of the `auth` and `mailhog` services
      - Volume for the `mailhog` service

    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      <div className="flex flex-col gap-3">

        ```yml docker-compose.yml
        # docker-compose.yml

        version: '3.8'
        services:
          app:
            environment:
              AUTH_SERVER_URL: http://localhost:4000
          hasura:
            environment:
              HASURA_GRAPHQL_JWT_SECRET: '{"type":"HS256", "key":"5152fa850c02dc222631cca898ed1485821a70912a6e3649c49076912daa3b62182ba013315915d64f40cddfbb8b58eb5bd11ba225336a6af45bbae07ca873f3","issuer":"hasura-auth"}'
          auth:
          # ...
          mailhog:
          # ...

        volumes:
          mailhog-data:
        ```

      </div>
    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={2}>
    <StepHikeCompact.Details title="Enable the auth schema and metadata module">

      The metadata module describes the `auth` service's modelling to the Hasura server.
      
      Bring up the `auth` service for it to initialize its schema.

      Hit enter to select the `default` database when prompted by the `hasura migrate` command.

    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      <div className="flex flex-col gap-3">

        ```bash Terminal
        # app>
        hasura migrate create create_auth_schema
        ```

        ```bash Terminal
        # host>
        # reset permissions for files generated inside the container
        sudo chown -R $USER:$USER .
        ```

        ```sql migrations/default/1684412516917_create_app_schema/up.sql
        -- migrations/default/XXXXXXXXXXXXX_create_app_schema/up.sql

        create schema if not exists auth;
        ```

        ```bash Terminal
        # app>
        source bin/commands.sh
        he module import hasura-auth
        compiledeploy
        ```

        ```bash Terminal
        # host>
        docker compose up -d auth
        ```

      </div>
    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={3}>
    <StepHikeCompact.Details title="Declare model permissions">

      Declaratively define authorization permissions based on the signed in user id using the `permissions` function.
      
      Then compile and deploy.

    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      <div className="flex flex-col gap-3">

      ```js models/Users.js
      // models/Users.js

      const { hasMany } = require("helium-for-hasura");

      class Users {
        static get relationships() {
          return [hasMany("tasks", require("./Tasks"), "user_id")];
        }

        static get permissions() {
          const pred = eq("id", "X-Hasura-User-Id");
          return {
            select: permission(pred, ["id", "name"]),
            update: permission(pred, ["name"]),
          };
        }
      }

      module.exports = Users;
      ```

      ```js models/Tasks.js
      // models/Tasks.js

      const { belongsTo, permission } = require("helium-for-hasura");

      class Tasks {
        static get relationships() {
          return [belongsTo("user", require("./Users"), "user_id")];
        }

        static get permissions() {
          const pred = eq("user_id", "X-Hasura-User-Id"),
            cols = ["id", "title", "body", "user_id"];
          return {
            select: permission(pred, cols),
            insert: permission(pred, cols),
            update: permission(pred, cols),
            delete: permission(pred),
          };
        }
      }

      module.exports = Tasks;
      ```

      ```bash Terminal
      # app>
      source bin/commands.sh
      compiledeploy
      ```

      </div>
    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={4}>
    <StepHikeCompact.Details title="Test the permission rules">

      We now have a secured API that we can open up to the world.

      Permission rules defined at the model level apply to:
      - All queries, including access through relations and aggregations
      - `select`, `insert`, `update`, `postUpdate`, and `delete` permissions can be defined

    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      <div className="flex flex-col gap-3">

      ```bash Terminal
      # app>
      hasura migrate create create_app_schema
      ```

      ```bash Terminal
      # host>
      # reset permissions for files generated inside the container
      sudo chown -R $USER:$USER .
      ```

      ```sql migrations/1624290000000_create_app_schema/up.sql
      -- migrations/XXXXXXXXXXXXX_create_app_schema/up.sql

      create extension if not exists "uuid-ossp";

      create table users (
        id uuid primary key default uuid_generate_v4(),
        name text not null,
        created_at timestamp with time zone not null default now()
      );

      create table tasks (
        id uuid primary key default uuid_generate_v4(),
        title text not null,
        body text not null,
        user_id uuid not null,
        created_at timestamp with time zone not null default now()
      );
      ```

      </div>
    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={5}>
    <StepHikeCompact.Details title="Build and deploy an API">

      Define some models and their relationships.

      Then compile and deploy.

      `bin/commands.sh` contains aliases and helper functions to speed up development.

    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      <div className="flex flex-col gap-3">

      ```js models/Users.js
      // helium/models/Users.js

      const { hasMany } = require("helium-for-hasura");

      class Users {
        static get relationships() {
          return [hasMany("tasks", require("./Tasks"), "user_id")];
        }
      }

      module.exports = Users;
      ```

      ```js models/Tasks.js
      // helium/models/Tasks.js

      const { belongsTo } = require("helium-for-hasura");

      class Tasks {
        static get relationships() {
          return [belongsTo("user", require("./Users"), "user_id")];
        }
      }

      module.exports = Tasks;
      ```

      ```bash Terminal
      # app>
      source bin/commands.sh
      compiledeploy
      ```

      </div>
    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={6}>
    <StepHikeCompact.Details title="Add some seed data">

      The API is up and running!

      Add seed data with the Hasura mutation API.

    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      <div className="flex flex-col gap-3">

      ```js helium/seeds/seedData.js
      // helium/seeds/seedData.js

      const users = [
        { name: "John Doe", id: "20388f23-f70d-4c6d-86c3-b34d9b2d8280", },
        { name: "Jane Doe", id: "67a12702-fc96-49df-8295-1bd6303aa557", },
      ];

      const tasks = [
        {
          id: "f63e724c-b297-4379-a76b-27029fcefcb1",
          title: "Task 1", body: "Task 1 body",
          user_id: users[0].id,
        },
        {
          id: "d3896006-5d9a-4094-818c-f8ab0994dac6",
          title: "Task 2", body: "Task 2 body",
          user_id: users[0].id,
        },
        {
          id: "d3ef7d45-75f5-410e-b290-66a5a4716757",
          title: "Task 3", body: "Task 3 body",
          user_id: users[1].id,
        },
      ];

      module.exports = { users, tasks };
      ```

      ```js helium/seeds/writeSeedData.js
      // helium/seeds/writeSeedData.js

      const { gql } = require("graphql-request");
      const { makeQuery } = require("../utils");

      const { users, tasks } = require("./seedData");

      async function writeSeedData() {
        const res = await makeQuery(
          gql`
            mutation (
              $users: [users_insert_input!]!
              $tasks: [tasks_insert_input!]!
            ) {
              insert_users(objects: $users) {
                returning { id }
              }
              insert_tasks(objects: $tasks) {
                returning { id }
              }
            }
          `,
          { users, tasks },
          { "X-Hasura-Admin-Secret": process.env.HASURA_GRAPHQL_ADMIN_SECRET }
        );

        console.log(res.data);
      }

      writeSeedData();
      ```

      ```bash Terminal
      # app>
      node helium/seeds/writeSeedData.js
      ```

        <RefDetailCollapse
          label="Output"
          defaultOpen={false}
        >
          
          ```bash Terminal
          TODO
          ```

        </RefDetailCollapse>

      </div>
    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={7}>
    <StepHikeCompact.Details title="Test the query API">

      The test case outputs the query result.

      At this point, we have an expressive API that supports relationships, filtering, pagination, aggregations, and more.

    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      <div className="flex flex-col gap-3">

        ```js helium/test/api.test.js
        // helium/test/api.test.js

        const { gql } = require("graphql-request");
        const { makeQuery } = require("../utils");

        const { users } = require("../seeds/seedData");

        test("can query the database with admin secret", async () => {
          const res = await makeQuery(
            gql`
              query MyQuery {
                users(where: { id: { _eq: "${users[0].id}" } }) {
                  name
                  tasks {
                    title
                    id
                  }
                }
              }
            `,
            undefined,
            { "X-Hasura-Admin-Secret": process.env.HASURA_GRAPHQL_ADMIN_SECRET }
          );

          expect(res.data.data.users).not.toBeUndefined();
          console.log(JSON.stringify(res.data, null, 2));
        });
        ```

        ```bash Terminal
        # app>
        yarn test
        ```

        <RefDetailCollapse
          label="Output"
          defaultOpen={false}
        >
          
          ```bash Terminal
          {
            "data": {
              "users": [
                {
                  "name": "John Doe",
                  "tasks": [
                    { "title": "Task 1", "id": "f63e724c-b297-4379-a76b-27029fcefcb1" },
                    { "title": "Task 2", "id": "d3896006-5d9a-4094-818c-f8ab0994dac6" }
                  ]
                }
              ]
            }
          }
          ```

        </RefDetailCollapse>

      </div>
    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={7}>
    <StepHikeCompact.Details title="Next: Add permissions">

      Declaratively add authenication and authorization to the API.

        <Link
          href="/docs/"
          passHref
        >
          <a className={'col-span-12 md:col-span-6'}>
            <IconPanel 
              title="Add permissions"
              icon="/docs/img/icons/menu/storage"
              background={true}
              showLink={false}
            />
          </a>
        </Link>

    </StepHikeCompact.Details>

    <StepHikeCompact.Code>

    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

</StepHikeCompact>

export const Page = ({ children }) => <Layout meta={meta} children={children} hideToc={true} />

export default Page
